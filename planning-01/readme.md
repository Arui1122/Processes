## 如何提高 qps 或是降低響應速度?

### 1. 提高 QPS 的策略

- 資料庫讀寫分離（讀操作分配到從庫）\
  因為大多數社交媒體的讀取操作遠遠多於寫入操作。通過將讀操作分配到多個從庫，能降低主庫的負擔，提升整體的並行讀取能力。
- 用戶分類及 Redis 快取策略（活躍 vs 非活躍用戶）\
  根據用戶的活躍度對快取策略進行分配，為最需要快速響應的用戶提供更多的資源，例如緩存更多貼文，提升整體 QPS 表現。
- Redis 緩存熱門文章和用戶資料 \
  將熱門文章及使用者資料（如個人資訊）快取到 Redis 中，減少對資料庫的頻繁讀取，能減少後端壓力，提升服務對於熱門資料查詢的並發能力。
- 非同步處理與消息隊列 \
  使用消息隊列將非必要的計算工作（如貼文的點讚數、通知等）進行異步處理，避免在同步流程中執行耗時的計算操作，減少後端阻塞，提升系統的並行查詢處理能力。
- 動態擴展服務器節點（Kubernetes）\
  利用 Kubernetes 進行水平擴展，在高流量時動態增加伺服器節點以應對請求量，確保高併發下的 QPS 穩定增長。

### 2. 降低響應時間的策略

- 主頁貼文分批返回（分頁，Pagination）\
  分批返回貼文而不是一次性返回所有貼文，減少一次請求的響應時間和傳輸數據量，改善使用者體驗。
- 使用 CDN 緩存靜態資源 \
  CDN 可以降低圖片、CSS、JavaScript 等靜態資源的加載時間，減少伺服器的負載並優化整體的使用者體驗。
- Redis 緩存熱門文章和用戶資料 \
  對於頻繁查詢的數據來說，如熱門貼文和用戶個人資料，直接從 Redis 中獲取可以降低資料獲取的延遲。
- 只快取文章索引，而非文章內容 \
  對於文章內容較多的情況，只快取文章索引，從 Redis 中快速讀取索引後，再通過索引去查找具體的資料庫資料。
- 連接池 \
  使用資料庫連接池來有效管理連接，避免頻繁創建和關閉連接的開銷。

## 哪些資訊可以運用 cache ?

1. 緩存首頁 feed 和個人 feed，當追蹤的用戶發布新貼文時，直接更新緩存。
2. 用戶好友列表和關係數據快取，以減少大量讀取關聯表的開銷。
3. 將需要推送的通知或消息緩存在 Redis 中，這樣當用戶上線時，能迅速獲取待處理的通知。
4. 將用戶最近的行為資料（如最近瀏覽、點讚的貼文）暫時快取在 Redis 中，用於推薦算法和個性化推送。

## 大規模文字搜尋
### 1. 情境與瓶頸
在社群網站中，用戶創作內容的速度非常快，數量龐大。如果用戶想要進行所有貼文的全文檢索，搜索範圍非常廣，導致搜尋成本極高。

### 2. 倒排索引（Inverted Index）

倒排索引（Inverted Index）是一種用於降低全文搜索成本的資料結構。


- **傳統思路**：文件 -> 搜尋關鍵字
    要遍歷每篇文章，時間複雜度高。
- **倒排索引**：關鍵字 -> 文件列表
    事先構建一個詞彙表，並將每個詞彙與出現該詞彙的所有文章關聯起來，直接找到該關鍵字，直接回傳包含這個關鍵字的貼文們。


### 3. 如何生成倒排索引 - 斷詞

我們不需要將整篇文章中的每個詞彙都當作關鍵字。因此要透過**斷詞工具**來選擇哪些詞要保留並成為關鍵字，提高搜索效率。

- **中文斷詞**：用常見的中文斷詞套件（如結巴分詞），將句子拆解為詞彙，然後建立詞彙表和倒排列表。
- **儲存和更新**：當用戶新增文章時，就開始計算斷詞結果，產生關鍵詞加入索引，並將文章 ID 存入相關關鍵詞的倒排列表中。
    - **詞彙表（Term Dictionary）**：儲存所有獨特的詞彙。
    - **倒排列表（Posting List）**：每個詞彙對應的貼文 ID 列表。

### 4. 合適資料庫
**Elasticsearch**，是專為全文檢索和大規模資料搜索設計的分布式搜索引擎。

- 優點 : 原生支持倒排索引結構，搜索功能高效
- 缺點 : 硬體規格限制成本高，如記憶體要求 8G ，但 AWS 免費方案 t2.micro 只有 1G



## 熱門推文問題
### 1. 情境與瓶頸
Threads 首頁會顯示所有社群貼文，這些貼文可能來自朋友、新聞媒體、或你不認識的帳號的熱門內容推薦。這些顯示的貼文依賴於系統設計的 News Feed 系統，透過訂閱（Subscription）關係來決定每位使用者應該看到哪些內容。

然而，在內容多樣又龐大的社群媒體中，會遇到以下瓶頸：

- **龐大的資料量**：每秒都有一堆貼文生出來，系統如何在這麼多內容中，快速且有效地展示最相關的部分? 

- **即時性**：當熱門帳號（如 KOL 或新聞帳號）發布新內容時，必須在最短時間內推送給所有追隨者，避免重大新聞卻有人隔半天才收到消息。

- **個人化與排序**：如何決定哪些貼文優先展示，可能要看於互動（點讚、評論、分享），或社交網路的強度。這需要有好的**推薦演算法**產生最佳內容與排序來顯示。


### 2. Subscription 系統設計
好的 Subscription 系統，能讓每位用戶點點開首頁時，能夠看到最新、最相關的內容，目前我們為了確保大家能看到最新的消息，整理的議題：

#### **資料擴散（Fan-out）**
當一個熱門帳號發布貼文時，這個貼文需要擴散到其所有追隨者的消息流中。這種情境下，每次發表貼文等於同時觸發大量的資料寫入操作，特別是當帳號擁有數百萬粉絲時，這會對系統形成巨大的壓力。

- **高寫入壓力**：每次大帳號發文時，系統需要立即處理大量寫入，將消息分發給所有追隨者的動態牆中，容易導致性能瓶頸。

- **延遲問題**：若追隨者數量龐大，可能會導致系統無法及時推送內容，使得用戶看到的內容不是即時的，體驗大打折扣。

#### **解決方案**

- **Pull-based 模式**：等用戶打開首頁時才拉取他們的訂閱內容。這樣可以減少即時寫入的壓力，將計算延遲到用戶查詢的時間點進行處理。

- **混合 Push-Pull 模式**：對於活躍用戶，系統就即時推送貼文；而對於一般用戶或不活躍用戶，則可以使用 Pull 模式來延遲處理，這樣可以在確保重要內容及時推送的同時，平衡系統負載。

- **快取**：熱門內容，可以考慮先用快取存起來，當用戶需要查看時，減少資料庫的壓力。


## 團隊合作

### 1. Branching Model : GitHub Flow

比 git 多兩個服務，一個是 fork，另一個是 pull request（PR），以及 issue tracking 用法

先有一個共有的遠端倉庫 ( remote repository )，再各自 fork 回到自己的倉庫。開發好後，再發 PR 回去共有遠端倉庫，審核過後 merge 進 main

- 以 `main` 分支為主
- 其他分支，以 feature-driven 做開發
- 發 PR 時，設定至少一人 review 後才能 merge

### 2. [Trello 連結](https://trello.com/invite/b/6700c979269fd7ec893df31d/ATTIca1e94314681e3715094c133aec74204FE423D46/小組看板)

固定開會時間 : 週三晚上
